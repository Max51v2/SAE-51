<!--
    Auteur HTML + CSS : Maxime VALLET
    Version 1.2
-->

<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Login</title>
    <link rel="icon" type="images" href="./images/Logo.png">

    <!-- CSS Page -->
    <style>
        body{
            margin: 0;
        }
        #rootDiv{
            height: 100vh;
            width: 100vw;

            display: flex;
            flex-direction: column;
        }
        #bannerDiv{
            width: 100%;
            height: 50px;
            display: flex;
            flex-direction: row; 
            justify-content: space-between;
            background-color: #333333;
            color: #BDBDBD;
        }
        #help{
            height: 50px;
            padding-left: 15px;
            display: flex;
            flex-direction: row;
            align-items: center
        }
        #submitHelp{
            width: 120px;
            height: 50px;
            background-color: #333333;
            color: #BDBDBD;
            border: 0px;
            font-family: "Times New Roman";
            font-size: large;
        }
        #submitHelp p{
            display: flex;
            align-items: center;
            margin: 0;
            cursor: pointer;
        }
        #logoHelp{
            width: 30px;
            height: 30px;
            padding-right: 10px;
            align-items: center;
        }
        #pageName{
            height: 50px;
            display: flex;
            align-items: center
        }
        #placeholder{
            height: 50px;
            width: 140px;
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        #loginDiv{
            flex: 1;
            display: flex;

            justify-content: center;
            align-items: center;
        }
        #loginBox {
            height: 760px;
            width: 450px;
            background-color: #f0f5f5;
            border-radius: 25px;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
        }
        #logoDiv{
            height: 280px;
            width: 450px;
            margin-top: 90px;
            
            display: flex;
            justify-content: center;
        }
        #logo{
            height: 250px;
            width: 250px;
            
            border-radius: 15px;
            object-fit: cover;
        }
        #loginFormDiv{
            width: 350px;
            text-align: left;

            font-size: 18px;
        }
        #login{
            width: 350px;
            height: 30px;
        }
        #password{
            width: 350px;
            height: 30px;
        }
        #submit{
            align-items: center;
            width: 350px;
            height: 40px;
            background-color: #333333;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            margin: 0;
        }
        #style{
            height: fit-content;
            width: fit-content;
        }
    </style>
</head>


<body>
    <div id="rootDiv">
        <div id="bannerDiv">
            <div id="help">
                <button id="submitHelp" type="button">
                    <p><img id="logoHelp" src="./images/help.png" alt="Logo"> Aide</p>
                </button>
            </div>
            <div id="pageName">
                <h2>Page de login</h2>
            </div>
            <div id="placeholder"></div>
        </div>

        <div id="loginDiv">
            <div id="loginBox">
                <div id="logoDiv">
                    <img id="logo" src="./images/Logo.png" alt="Logo">
                </div>
                <div id="loginFormDiv">
                    <h1>Indentification</h1>
                    <form id="loginForm">
                        <label for="login">Nom d'utilisateur :</label>
                        <br>
                        <input type="text" id="login" name="login" required>
                        <br>
                        <label for="password">Mot de passe :</label>
                        <br>
                        <input type="password" id="password" name="password" required>
                        <br><br><br>
                        <button type="button" id="submit">Valider</button>
                        <br>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


<!-- ne pas toucher aux 2 scripts ci-dessous SAUF en cas de BUG -->
<script src="./JS/URL.js" defer></script>
<script src="./JS/TokenCheck.js" defer></script>

<script>
    //Auteur JS : Maxime VALLET
    //Version : 1.1

    //Code ici
    document.addEventListener("DOMContentLoaded", (event) => {

        //Redirection vers la page d'aide
        document.getElementById("submitHelp").onclick = function () {
            window.location.href = 'help.html';
        };

        
        //Vérification du MDP
        document.getElementById("submit").onclick = function () { 

            //Données fournies par l'utilisateur
            var login = document.getElementById("login").value;
            var password = document.getElementById("password").value;

            //Reset form
            document.getElementById("loginForm").reset();

            //Vérification auprès du Servlet
            fetch(`https://${window.ServerIP}:8443/SAE51/CheckPassword`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ login: login, password: password, Test: false })
            }).then(response => response.json())
            .then(CheckPasswordResult);
        };
        

        //Vérification de la réponse du Servlet CheckPassword
        function CheckPasswordResult(response){
            if(response.erreur === "none"){
                //Stockage du token, login et des droits (uniquement à titre indicatif car les servlets revérifient !)
                sessionStorage.setItem("login", response.login);
                sessionStorage.setItem("droits", response.droits);
                sessionStorage.setItem("token", response.token);

                //Console
                console.log("login => login : "+sessionStorage.getItem("login"));
                console.log("login => droits : "+sessionStorage.getItem("droits"));
                console.log("login => token : "+sessionStorage.getItem("token")); //le token ici est en clair contrairement à la BD (hash Bcrypt)

                //Redirection page
                currentToken = sessionStorage.getItem("token");
                fetch(`https://${window.ServerIP}:8443/SAE51/GetRedirection`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token: currentToken, currentPage: window.currentPage, Test: false })
                }).then(response => response.json())
                .then(GetRedirectionResult);
            }
            else{
                //On affiche l'erreur
                console.log("login => CheckPasswordResult => Erreur : "+response.erreur);
            }
        }


        //Vérification du résultat du Sevlet GetRedirection
        function GetRedirectionResult(response){
            if(response.erreur === "none"){
                if(response.redirect === "none"){
                    //Rien
                }
                else{
                    window.location.href = response.redirect;
                }
            }
            else{
                //On affiche l'erreur
                console.log("login => GetRedirectionResult => Erreur : "+response.erreur);

                //Redirection vers le login s'il n'y pas de règle de redirection dans la BD
                if(response.erreur === "Pas de redirection (BD)"){
                    //Redireciton vers login.html qui en théorie en a bien une
                    window.location.href = 'login.html';
                }
            }
        }
    });
</script>